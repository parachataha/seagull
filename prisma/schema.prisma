generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//
// USER PROFILE DATA
//
model User {
  id        Int     @id @default(autoincrement())
  name      String
  email     String  @unique
  slug      String? @unique
  password  String
  about     String?
  label     String?
  avatarId  Int     @default(1)
  createdAt Int
  updatedAt Int?

  // Optional information to provide more public details
  location  String?
  timezone  String?
  startWork Int?
  endWork   Int?

  avatar    Image?      @relation(fields: [avatarId], references: [id])
  sessions  Session[]
  images    Image[]     @relation("UserImages")
  skills    UserSkill[]
  timelines Timeline[]
  project   Project[]
  blogs     Blog[]
}

model UserSkill {
  id        Int         @id @default(autoincrement())
  name      String
  userId    Int
  parentId  Int?
  order     Int?
  color     String      @default("255, 255, 255")
  parent    UserSkill?  @relation("SkillHierarchy", fields: [parentId], references: [id])
  children  UserSkill[] @relation("SkillHierarchy")
  createdAt Int

  user         User           @relation(fields: [userId], references: [id])
  ProjectSkill ProjectSkill[]

  @@unique([name, userId, parentId]) // Prevents duplicate skills per user under same parent
}

model Image {
  id          Int     @id @default(autoincrement())
  name        String
  description String?
  url         String
  size        Int
  userId      Int?
  createdAt   Int

  user         User?          @relation("UserImages", fields: [userId], references: [id], onDelete: Cascade)
  User         User[]
  ProjectImage ProjectImage[]
  Doc          Doc[]
  Blog         Blog[]
}

//
// AUTHENTICATION
//
model Session {
  user       User    @relation(fields: [userId], references: [id])
  id         String  @id
  userId     Int
  userAgent  String?
  secretHash Bytes
  createdAt  Int
  expiresAt  Int
}

//
// TIMELINES
//
model Timeline {
  id          Int     @id @default(autoincrement())
  name        String
  description String?
  userId      Int
  createdAt   Int
  updatedAt   Int?

  user     User      @relation(fields: [userId], references: [id])
  projects Project[]

  @@unique([userId, name])
}

//
// PROJECTS
//
model Project {
  id             Int     @id @default(autoincrement())
  timelineId     Int
  title          String
  description    String?
  type           String?
  locationType   String?
  organizationId Int?
  teamId         Int?
  clientId       Int?
  startDate      Int
  endDate        Int?
  order          Int?

  caseStudyUrl String?
  projectUrl   String?

  client   User?    @relation(fields: [clientId], references: [id])
  timeline Timeline @relation(fields: [timelineId], references: [id])

  // Relation to skills
  skills ProjectSkill[]
  // Relation to images
  images ProjectImage[]
}

model ProjectSkill {
  id        Int @id @default(autoincrement())
  projectId Int
  skillId   Int

  project Project   @relation(fields: [projectId], references: [id])
  skill   UserSkill @relation(fields: [skillId], references: [id])

  @@unique([projectId, skillId])
}

model ProjectImage {
  id        Int @id @default(autoincrement())
  projectId Int
  imageId   Int

  project Project @relation(fields: [projectId], references: [id])
  image   Image   @relation(fields: [imageId], references: [id])

  @@unique([projectId, imageId])
}

//
// BLOGS
//
model Blog {
  id             Int      @id @default(autoincrement())
  slug           String   @unique
  title          String
  description    String?
  userId         Int?
  teamId         Int?
  organizationId Int?
  thumbnailId    Int?
  pinnedDocId    Int?     @unique
  createdAt      Int
  updatedAt      Int?
  isPublic       Boolean? @default(true)

  // Relations
  author    User?  @relation(fields: [userId], references: [id])
  thumbnail Image? @relation(fields: [thumbnailId], references: [id])
  pinnedDoc Doc?   @relation("PinnedDoc", fields: [pinnedDocId], references: [id])
  docs      Doc[]
}

model Doc {
  id          Int     @id @default(autoincrement())
  slug        String
  title       String
  description String?
  body        Json
  thumbnailId Int?
  blogId      Int
  createdAt   Int
  updatedAt   Int?
  isPublished Boolean @default(false)
  order       Int?

  // Relations
  blog      Blog   @relation(fields: [blogId], references: [id])
  pinnedBy  Blog?  @relation("PinnedDoc")
  thumbnail Image? @relation(fields: [thumbnailId], references: [id])

  @@unique([blogId, slug])
}
